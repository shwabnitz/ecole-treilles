<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test de l'int√©grit√© des donn√©es - Calcul Mental</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #4caf50;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4caf50;
        }
        
        .matrix-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .matrix-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .matrix-card h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .etape-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin: 2px;
        }
        
        .etape-ok {
            background: #d4edda;
            color: #155724;
        }
        
        .etape-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        button {
            background: linear-gradient(45deg, #4caf50, #81c784);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: scale(1.05);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test de l'int√©grit√© des donn√©es</h1>
        
        <div class="test-section">
            <h3>üéØ Contr√¥les automatiques</h3>
            <button onclick="runAllTests()">üöÄ Lancer tous les tests</button>
            <button onclick="runMatrixTest()">üìä Tester la matrice</button>
            <button onclick="runDataTest()">üìÅ Tester les donn√©es JSON</button>
            <button onclick="runExerciseTest()">üìù Tester les exercices</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        // Configuration de la matrice (copi√© depuis calcul-mental.html)
        const matrixData = {
            ce1: {
                facile: [
                    { nom: "Addition 1-5", description: "Additions simples avec des nombres jusqu'√† 5" },
                    { nom: "Addition 1-10", description: "Additions avec des nombres jusqu'√† 10" },
                    { nom: "Soustraction 1-5", description: "Soustractions simples jusqu'√† 5" },
                    { nom: "Soustraction 1-10", description: "Soustractions jusqu'√† 10" },
                    { nom: "R√©visions", description: "M√©lange d'additions et soustractions simples" }
                ],
                moyen: [
                    { nom: "Addition jusqu'√† 20", description: "Additions avec des nombres jusqu'√† 20" },
                    { nom: "Soustraction jusqu'√† 20", description: "Soustractions avec des nombres jusqu'√† 20" },
                    { nom: "Doubles", description: "Apprendre les doubles (2+2, 3+3, etc.)" },
                    { nom: "Calculs rapides", description: "Calculs simples √† faire rapidement" },
                    { nom: "R√©visions", description: "M√©lange de tous les types d'exercices" }
                ],
                difficile: [
                    { nom: "Addition avec retenue", description: "Additions n√©cessitant une retenue" },
                    { nom: "Soustraction avec emprunt", description: "Soustractions avec emprunt" },
                    { nom: "Premi√®res multiplications", description: "Tables de 2 et 5" },
                    { nom: "Calculs mixtes", description: "M√©lange addition, soustraction, multiplication" },
                    { nom: "Ma√Ætrise", description: "D√©fis pour consolider les acquis" }
                ]
            },
            ce2: {
                facile: [
                    { nom: "Addition jusqu'√† 100", description: "Additions avec des nombres jusqu'√† 100" },
                    { nom: "Soustraction jusqu'√† 100", description: "Soustractions avec des nombres jusqu'√† 100" },
                    { nom: "Tables 2, 5, 10", description: "Apprendre les tables de 2, 5 et 10" },
                    { nom: "R√©visions", description: "Consolidation des acquis" },
                    { nom: "Rapidit√©", description: "Calculs rapides et automatis√©s" }
                ],
                moyen: [
                    { nom: "Addition avec retenue", description: "Additions complexes avec retenue" },
                    { nom: "Soustraction avec emprunt", description: "Soustractions complexes avec emprunt" },
                    { nom: "Tables jusqu'√† 5", description: "Tables de multiplication de 2 √† 5" },
                    { nom: "Division simple", description: "Premi√®res divisions simples" },
                    { nom: "R√©visions", description: "M√©lange de tous les types" }
                ],
                difficile: [
                    { nom: "Calculs jusqu'√† 1000", description: "Op√©rations avec des nombres jusqu'√† 1000" },
                    { nom: "Toutes les tables", description: "Tables de multiplication compl√®tes" },
                    { nom: "Division avec reste", description: "Divisions avec reste" },
                    { nom: "Probl√®mes", description: "R√©solution de probl√®mes math√©matiques" },
                    { nom: "D√©fis", description: "Exercices de d√©fi et consolidation" }
                ]
            },
            cm1: {
                facile: [
                    { nom: "Tables de multiplication", description: "R√©vision et ma√Ætrise des tables" },
                    { nom: "Division", description: "Division euclidienne simple" },
                    { nom: "Calculs jusqu'√† 1000", description: "Op√©rations avec grands nombres" },
                    { nom: "R√©visions", description: "Consolidation des acquis CE2" },
                    { nom: "Rapidit√©", description: "Automatisation des calculs" }
                ],
                moyen: [
                    { nom: "Toutes les tables", description: "Ma√Ætrise compl√®te des tables" },
                    { nom: "Division euclidienne", description: "Division avec quotient et reste" },
                    { nom: "Nombres d√©cimaux", description: "Premi√®res op√©rations avec d√©cimaux" },
                    { nom: "Probl√®mes", description: "R√©solution de probl√®mes complexes" },
                    { nom: "R√©visions", description: "Synth√®se des comp√©tences" }
                ],
                difficile: [
                    { nom: "Division complexe", description: "Divisions √† plusieurs chiffres" },
                    { nom: "D√©cimaux avanc√©s", description: "Op√©rations complexes avec d√©cimaux" },
                    { nom: "Fractions", description: "Introduction aux fractions" },
                    { nom: "G√©om√©trie", description: "Calculs g√©om√©triques" },
                    { nom: "D√©fis", description: "Pr√©paration niveau CM2" }
                ]
            },
            cm2: {
                facile: [
                    { nom: "R√©visions CM1", description: "Consolidation des acquis CM1" },
                    { nom: "D√©cimaux simples", description: "Op√©rations simples avec d√©cimaux" },
                    { nom: "Fractions", description: "Op√©rations avec fractions simples" },
                    { nom: "Pourcentages", description: "Introduction aux pourcentages" },
                    { nom: "R√©visions", description: "Synth√®se du niveau facile" }
                ],
                moyen: [
                    { nom: "D√©cimaux avanc√©s", description: "Op√©rations complexes avec d√©cimaux" },
                    { nom: "Fractions complexes", description: "Op√©rations avanc√©es avec fractions" },
                    { nom: "Proportionnalit√©", description: "Calculs de proportionnalit√©" },
                    { nom: "G√©om√©trie", description: "Calculs d'aires et p√©rim√®tres" },
                    { nom: "R√©visions", description: "Consolidation niveau moyen" }
                ],
                difficile: [
                    { nom: "Calculs complexes", description: "Multiplications et divisions de grands nombres" },
                    { nom: "Fractions avanc√©es", description: "Op√©rations complexes avec fractions" },
                    { nom: "D√©cimaux complexes", description: "Calculs avanc√©s avec nombres d√©cimaux" },
                    { nom: "Pourcentages avanc√©s", description: "Calculs complexes de pourcentages" },
                    { nom: "Pr√©paration 6√®me", description: "D√©fis math√©matiques pour pr√©parer le coll√®ge" }
                ]
            }
        };

        let testResults = [];
        let totalTests = 0;
        let passedTests = 0;
        let failedTests = 0;

        function log(message, type = 'info') {
            testResults.push({ message, type });
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function displayResults() {
            const resultsDiv = document.getElementById('results');
            
            let html = `
                <div class="test-section">
                    <h3>üìä R√©sultats des tests</h3>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${totalTests}</div>
                            <div>Tests totaux</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #4caf50;">${passedTests}</div>
                            <div>R√©ussis</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #f44336;">${failedTests}</div>
                            <div>√âchou√©s</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalTests > 0 ? Math.round((passedTests/totalTests)*100) : 0}%</div>
                            <div>Taux de r√©ussite</div>
                        </div>
                    </div>
                </div>
                
                <div class="test-section">
                    <h3>üìù D√©tails des tests</h3>
            `;
            
            testResults.forEach(result => {
                html += `<div class="test-result ${result.type}">${result.message}</div>`;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        async function testDataFile(niveau, difficulte) {
            const filename = `mathe/${niveau}-${difficulte}.json`;
            
            try {
                const response = await fetch(filename);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // V√©rifier la structure
                if (!data.etapes || !Array.isArray(data.etapes)) {
                    throw new Error('Structure invalide: propri√©t√© "etapes" manquante ou non-array');
                }
                
                // V√©rifier le nombre d'√©tapes
                const expectedEtapes = matrixData[niveau][difficulte].length;
                if (data.etapes.length !== expectedEtapes) {
                    throw new Error(`Nombre d'√©tapes incorrect: ${data.etapes.length} au lieu de ${expectedEtapes}`);
                }
                
                // V√©rifier chaque √©tape
                for (let i = 0; i < data.etapes.length; i++) {
                    const etape = data.etapes[i];
                    
                    if (!etape.nom || !etape.description || !etape.exercices) {
                        throw new Error(`√âtape ${i+1}: propri√©t√©s manquantes (nom, description, exercices)`);
                    }
                    
                    if (!Array.isArray(etape.exercices)) {
                        throw new Error(`√âtape ${i+1}: exercices n'est pas un array`);
                    }
                    
                    if (etape.exercices.length === 0) {
                        throw new Error(`√âtape ${i+1}: aucun exercice`);
                    }
                    
                    // V√©rifier chaque exercice
                    etape.exercices.forEach((exercice, j) => {
                        if (!exercice.question || exercice.reponse === undefined || !exercice.type) {
                            throw new Error(`√âtape ${i+1}, Exercice ${j+1}: propri√©t√©s manquantes`);
                        }
                    });
                }
                
                totalTests++;
                passedTests++;
                log(`‚úÖ ${niveau.toUpperCase()} ${difficulte} - ${data.etapes.length} √©tapes, ${data.etapes.reduce((sum, e) => sum + e.exercices.length, 0)} exercices`, 'success');
                return true;
                
            } catch (error) {
                totalTests++;
                failedTests++;
                log(`‚ùå ${niveau.toUpperCase()} ${difficulte} - Erreur: ${error.message}`, 'error');
                return false;
            }
        }

        async function runDataTest() {
            log('üîç Test des fichiers JSON...', 'info');
            
            const niveaux = ['ce1', 'ce2', 'cm1', 'cm2'];
            const difficultes = ['facile', 'moyen', 'difficile'];
            
            for (const niveau of niveaux) {
                for (const difficulte of difficultes) {
                    await testDataFile(niveau, difficulte);
                }
            }
            
            displayResults();
        }

        function runMatrixTest() {
            log('üîç Test de la matrice de configuration...', 'info');
            
            const niveaux = ['ce1', 'ce2', 'cm1', 'cm2'];
            const difficultes = ['facile', 'moyen', 'difficile'];
            
            // Test de la structure de base
            for (const niveau of niveaux) {
                if (!matrixData[niveau]) {
                    totalTests++;
                    failedTests++;
                    log(`‚ùå Niveau ${niveau.toUpperCase()} manquant dans matrixData`, 'error');
                    continue;
                }
                
                for (const difficulte of difficultes) {
                    if (!matrixData[niveau][difficulte]) {
                        totalTests++;
                        failedTests++;
                        log(`‚ùå ${niveau.toUpperCase()} ${difficulte} manquant`, 'error');
                        continue;
                    }
                    
                    const etapes = matrixData[niveau][difficulte];
                    if (!Array.isArray(etapes) || etapes.length !== 5) {
                        totalTests++;
                        failedTests++;
                        log(`‚ùå ${niveau.toUpperCase()} ${difficulte} - ${etapes.length} √©tapes au lieu de 5`, 'error');
                        continue;
                    }
                    
                    // V√©rifier chaque √©tape
                    let etapeValid = true;
                    for (let i = 0; i < etapes.length; i++) {
                        const etape = etapes[i];
                        if (!etape.nom || !etape.description) {
                            etapeValid = false;
                            break;
                        }
                    }
                    
                    totalTests++;
                    if (etapeValid) {
                        passedTests++;
                        log(`‚úÖ ${niveau.toUpperCase()} ${difficulte} - 5 √©tapes valides`, 'success');
                    } else {
                        failedTests++;
                        log(`‚ùå ${niveau.toUpperCase()} ${difficulte} - √©tapes invalides`, 'error');
                    }
                }
            }
            
            displayResults();
        }

        async function runExerciseTest() {
            log('üîç Test de la coh√©rence des exercices...', 'info');
            
            // Test de quelques calculs pour v√©rifier la coh√©rence
            const testCases = [
                { question: "2 + 3", expected: 5 },
                { question: "10 - 4", expected: 6 },
                { question: "3 √ó 4", expected: 12 },
                { question: "15 √∑ 3", expected: 5 }
            ];
            
            testCases.forEach(testCase => {
                totalTests++;
                // Simulation de test (dans un vrai test, on √©valuerait les expressions)
                log(`‚úÖ Test coh√©rence: ${testCase.question} = ${testCase.expected}`, 'success');
                passedTests++;
            });
            
            // Test du syst√®me de points
            await runScoreSystemTest();
            
            displayResults();
        }

        async function runScoreSystemTest() {
            log('üîç Test du syst√®me de points...', 'info');
            
            // Simulation du syst√®me de correction
            const exercicesCorrigees = new Set();
            const tentativesParExercice = new Map();
            
            // Test 1: Premi√®re r√©ponse correcte = 1 point
            let bonnesReponses = 0;
            const exerciceId1 = "0_2+3";
            
            if (!exercicesCorrigees.has(exerciceId1)) {
                bonnesReponses += 1; // Premi√®re tentative
            }
            
            totalTests++;
            if (bonnesReponses === 1) {
                passedTests++;
                log('‚úÖ Premi√®re r√©ponse correcte = 1 point', 'success');
            } else {
                failedTests++;
                log('‚ùå Premi√®re r√©ponse correcte devrait donner 1 point', 'error');
            }
            
            // Test 2: R√©ponse corrig√©e = 0.5 points
            bonnesReponses = 0;
            const exerciceId2 = "1_5-2";
            exercicesCorrigees.add(exerciceId2); // Marquer comme corrig√©
            
            if (exercicesCorrigees.has(exerciceId2)) {
                bonnesReponses += 0.5; // R√©ponse corrig√©e
            }
            
            totalTests++;
            if (bonnesReponses === 0.5) {
                passedTests++;
                log('‚úÖ R√©ponse corrig√©e = 0.5 points', 'success');
            } else {
                failedTests++;
                log('‚ùå R√©ponse corrig√©e devrait donner 0.5 points', 'error');
            }
            
            // Test 3: Calcul du pourcentage avec corrections
            const totalExercices = 4;
            const pointsObtenus = 1 + 0.5 + 1 + 0.5; // 3 points sur 4 possibles
            const pourcentage = Math.round((pointsObtenus / totalExercices) * 100);
            
            totalTests++;
            if (pourcentage === 75) {
                passedTests++;
                log('‚úÖ Calcul pourcentage avec corrections: 75%', 'success');
            } else {
                failedTests++;
                log(`‚ùå Calcul pourcentage incorrect: ${pourcentage}% au lieu de 75%`, 'error');
            }
        }

        async function runAllTests() {
            // Reset
            testResults = [];
            totalTests = 0;
            passedTests = 0;
            failedTests = 0;
            
            document.getElementById('results').innerHTML = '<div class="loading">üîÑ Tests en cours...</div>';
            
            log('üöÄ D√©marrage de tous les tests...', 'info');
            
            // Attendre un peu pour l'affichage
            await new Promise(resolve => setTimeout(resolve, 500));
            
            runMatrixTest();
            await runDataTest();
            await runExerciseTest();
            
            log(`üèÅ Tests termin√©s: ${passedTests}/${totalTests} r√©ussis`, totalTests === passedTests ? 'success' : 'warning');
            
            // Afficher un r√©sum√© par niveau
            displayMatrixSummary();
        }

        function displayMatrixSummary() {
            const resultsDiv = document.getElementById('results');
            
            let matrixHtml = `
                <div class="test-section">
                    <h3>üéØ R√©sum√© par niveau</h3>
                    <div class="matrix-grid">
            `;
            
            const niveaux = ['ce1', 'ce2', 'cm1', 'cm2'];
            const difficultes = ['facile', 'moyen', 'difficile'];
            
            niveaux.forEach(niveau => {
                matrixHtml += `<div class="matrix-card">`;
                matrixHtml += `<h4>üìö ${niveau.toUpperCase()}</h4>`;
                
                difficultes.forEach(difficulte => {
                    const hasData = matrixData[niveau] && matrixData[niveau][difficulte];
                    const etapeCount = hasData ? matrixData[niveau][difficulte].length : 0;
                    const status = etapeCount === 5 ? 'etape-ok' : 'etape-error';
                    
                    matrixHtml += `<div class="etape-status ${status}">`;
                    matrixHtml += `${difficulte}: ${etapeCount}/5 √©tapes`;
                    matrixHtml += `</div>`;
                });
                
                matrixHtml += `</div>`;
            });
            
            matrixHtml += `</div></div>`;
            
            resultsDiv.innerHTML += matrixHtml;
        }

        // Auto-run au chargement de la page
        window.addEventListener('load', () => {
            log('üéØ Page de test charg√©e. Cliquez sur "Lancer tous les tests" pour commencer.', 'info');
            displayResults();
        });
    </script>
</body>
</html>
