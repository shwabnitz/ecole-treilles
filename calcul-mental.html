<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üßÆ Calcul Mental - Entra√Ænement Interactif</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Page de s√©lection du niveau -->
        <div class="selection-page" id="selectionPage">
            <h1 class="titre-principal">üßÆ Calcul Mental</h1>
            
            <div class="niveau-selection">
                <div class="niveau-btn active" data-niveau="ce1" onclick="selectionnerNiveau('ce1')">üìö CE1</div>
                <div class="niveau-btn" data-niveau="ce2" onclick="selectionnerNiveau('ce2')">üìñ CE2</div>
                <div class="niveau-btn" data-niveau="cm1" onclick="selectionnerNiveau('cm1')">üìó CM1</div>
                <div class="niveau-btn" data-niveau="cm2" onclick="selectionnerNiveau('cm2')">üìò CM2</div>
            </div>

            <div class="matrix-container" id="matrixContainer">
                <!-- Matrix wird dynamisch geladen -->
            </div>
            
        </div>

        <!-- Page du diaporama -->
        <div class="diaporama-page" id="diaporamaPage">
            <div class="header-diaporama">
                <div class="info-niveau" id="infoNiveau"></div>
                <div class="controles">
                    <button class="btn-controle btn-retour" onclick="retourSelection()">üè† Accueil</button>
                </div>
            </div>

            <div class="zone-exercice">
                <div class="exercice-actuel" id="exercice-actuel">
                    <div class="question-exercice" id="questionExercice">
                        Chargement...
                    </div>
                    <div class="zone-reponse">
                        <input type="number" class="input-reponse" id="inputReponse" placeholder="?">
                   <div class="btns-reponse">
                       <button class="btn-valider" id="btnValider" onclick="validerReponse()">
                           ‚úÖ Valider
                       </button>
                       <button class="btn-corriger" id="btnCorriger" onclick="corrigerReponse()" style="display: none;">
                           ‚úèÔ∏è Corriger
                       </button>
                       <button class="btn-continuer" id="btnContinuer" onclick="continuerExercice()" style="display: none;">
                           ‚û°Ô∏è Continuer
                       </button>
                   </div>
                    </div>
                    <div class="feedback" id="feedback"></div>
                    
                    <!-- Navigation Button -->
                    <div class="navigation-buttons">
                        <button class="btn-controle btn-precedent" onclick="exercicePrecedent()">‚¨ÖÔ∏è Pr√©c√©dent</button>
                    </div>
                </div>
            </div>

            <div class="progress-info">
                <div class="progress-text" id="progressText">Exercice 1 / 20</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cache f√ºr geladene √úbungsdaten
        let baseExercices = {};
        
        // Globale Variablen
        let exercicesActuels = [];
        let indexExercice = 0;
        let niveauActuel = '';
        let difficulteActuelle = '';
        let etapeActuelle = '';
        let reponseValidee = false;
        let audioContext = null;
        let bonnesReponses = 0;
        let totalReponses = 0;
        let exercicesCorrigees = new Set(); // Exercices qui ont √©t√© corrig√©s
        let tentativesParExercice = new Map(); // Nombre de tentatives par exercice
        
        // Matrix-Daten f√ºr jedes Niveau
        const matrixData = {
            ce1: {
                facile: [
                    { nom: "Addition 1-5", description: "Additions simples avec des nombres jusqu'√† 5" },
                    { nom: "Addition 1-10", description: "Additions avec des nombres jusqu'√† 10" },
                    { nom: "Soustraction 1-5", description: "Soustractions simples jusqu'√† 5" },
                    { nom: "Soustraction 1-10", description: "Soustractions jusqu'√† 10" },
                    { nom: "R√©visions", description: "M√©lange d'additions et soustractions simples" }
                ],
                moyen: [
                    { nom: "Addition jusqu'√† 20", description: "Additions avec des nombres jusqu'√† 20" },
                    { nom: "Soustraction jusqu'√† 20", description: "Soustractions avec des nombres jusqu'√† 20" },
                    { nom: "Doubles", description: "Apprendre les doubles (2+2, 3+3, etc.)" },
                    { nom: "Calculs rapides", description: "Calculs simples √† faire rapidement" },
                    { nom: "R√©visions", description: "M√©lange de tous les types d'exercices" }
                ],
                difficile: [
                    { nom: "Addition avec retenue", description: "Additions n√©cessitant une retenue" },
                    { nom: "Soustraction avec emprunt", description: "Soustractions avec emprunt" },
                    { nom: "Premi√®res multiplications", description: "Tables de 2 et 5" },
                    { nom: "Calculs mixtes", description: "M√©lange addition, soustraction, multiplication" },
                    { nom: "Ma√Ætrise", description: "D√©fis pour consolider les acquis" }
                ]
            },
            ce2: {
                facile: [
                    { nom: "Addition jusqu'√† 100", description: "Additions avec des nombres jusqu'√† 100" },
                    { nom: "Soustraction jusqu'√† 100", description: "Soustractions avec des nombres jusqu'√† 100" },
                    { nom: "Tables 2, 5, 10", description: "Apprendre les tables de 2, 5 et 10" },
                    { nom: "R√©visions", description: "Consolidation des acquis" },
                    { nom: "Rapidit√©", description: "Calculs rapides et automatis√©s" }
                ],
                moyen: [
                    { nom: "Addition avec retenue", description: "Additions complexes avec retenue" },
                    { nom: "Soustraction avec emprunt", description: "Soustractions complexes avec emprunt" },
                    { nom: "Tables jusqu'√† 5", description: "Tables de multiplication de 2 √† 5" },
                    { nom: "Division simple", description: "Premi√®res divisions simples" },
                    { nom: "R√©visions", description: "M√©lange de tous les types" }
                ],
                difficile: [
                    { nom: "Calculs jusqu'√† 1000", description: "Op√©rations avec des nombres jusqu'√† 1000" },
                    { nom: "Toutes les tables", description: "Tables de multiplication compl√®tes" },
                    { nom: "Division avec reste", description: "Divisions avec reste" },
                    { nom: "Probl√®mes", description: "R√©solution de probl√®mes math√©matiques" },
                    { nom: "D√©fis", description: "Exercices de d√©fi et consolidation" }
                ]
            },
            cm1: {
                facile: [
                    { nom: "Tables de multiplication", description: "R√©vision et ma√Ætrise des tables" },
                    { nom: "Division", description: "Division euclidienne simple" },
                    { nom: "Calculs jusqu'√† 1000", description: "Op√©rations avec grands nombres" },
                    { nom: "R√©visions", description: "Consolidation des acquis CE2" },
                    { nom: "Rapidit√©", description: "Automatisation des calculs" }
                ],
                moyen: [
                    { nom: "Toutes les tables", description: "Ma√Ætrise compl√®te des tables" },
                    { nom: "Division euclidienne", description: "Division avec quotient et reste" },
                    { nom: "Nombres d√©cimaux", description: "Premi√®res op√©rations avec d√©cimaux" },
                    { nom: "Probl√®mes", description: "R√©solution de probl√®mes complexes" },
                    { nom: "R√©visions", description: "Synth√®se des comp√©tences" }
                ],
                difficile: [
                    { nom: "Division complexe", description: "Divisions √† plusieurs chiffres" },
                    { nom: "D√©cimaux avanc√©s", description: "Op√©rations complexes avec d√©cimaux" },
                    { nom: "Fractions", description: "Introduction aux fractions" },
                    { nom: "G√©om√©trie", description: "Calculs g√©om√©triques" },
                    { nom: "D√©fis", description: "Pr√©paration niveau CM2" }
                ]
            },
            cm2: {
                facile: [
                    { nom: "R√©visions CM1", description: "Consolidation des acquis CM1" },
                    { nom: "D√©cimaux simples", description: "Op√©rations simples avec d√©cimaux" },
                    { nom: "Fractions", description: "Op√©rations avec fractions simples" },
                    { nom: "Pourcentages", description: "Introduction aux pourcentages" },
                    { nom: "R√©visions", description: "Synth√®se du niveau facile" }
                ],
                moyen: [
                    { nom: "D√©cimaux avanc√©s", description: "Op√©rations complexes avec d√©cimaux" },
                    { nom: "Fractions complexes", description: "Op√©rations avanc√©es avec fractions" },
                    { nom: "Proportionnalit√©", description: "Calculs de proportionnalit√©" },
                    { nom: "G√©om√©trie", description: "Calculs d'aires et p√©rim√®tres" },
                    { nom: "R√©visions", description: "Consolidation niveau moyen" }
                ],
                difficile: [
                    { nom: "Calculs complexes", description: "Multiplications et divisions de grands nombres" },
                    { nom: "Fractions avanc√©es", description: "Op√©rations complexes avec fractions" },
                    { nom: "D√©cimaux complexes", description: "Calculs avanc√©s avec nombres d√©cimaux" },
                    { nom: "Pourcentages avanc√©s", description: "Calculs complexes de pourcentages" },
                    { nom: "Pr√©paration 6√®me", description: "D√©fis math√©matiques pour pr√©parer le coll√®ge" }
                ]
            }
        };

        // Funktion zur Niveau-Auswahl
        function selectionnerNiveau(niveau) {
            // Alle Buttons deaktivieren
            document.querySelectorAll('.niveau-btn').forEach(btn => btn.classList.remove('active'));
            // Aktuellen Button aktivieren
            document.querySelector(`[data-niveau="${niveau}"]`).classList.add('active');
            
            // Matrix f√ºr das gew√§hlte Niveau anzeigen
            afficherMatrix(niveau);
        }
        
        // Funktion zur Anzeige der Matrix
        function afficherMatrix(niveau) {
            const container = document.getElementById('matrixContainer');
            const data = matrixData[niveau];
            
            let html = '<div class="matrix-grid">';
            
            // Header mit Schwierigkeitsgraden
            html += '<div class="matrix-header">';
            html += '<div class="matrix-cell header-empty"></div>';
            html += '<div class="matrix-cell header-difficulte">üå± Facile</div>';
            html += '<div class="matrix-cell header-difficulte">üåø Moyen</div>';
            html += '<div class="matrix-cell header-difficulte">üå≥ Difficile</div>';
            html += '</div>';
            
            // Zeilen mit √âtapes
            const maxEtapes = Math.max(data.facile.length, data.moyen.length, data.difficile.length);
            
            for (let i = 0; i < maxEtapes; i++) {
                html += '<div class="matrix-row">';
                html += `<div class="matrix-cell etape-label">√âtape ${i + 1}</div>`;
                
                ['facile', 'moyen', 'difficile'].forEach(difficulte => {
                    const etape = data[difficulte][i];
                    if (etape) {
                        html += `<div class="matrix-cell etape-btn" onclick="demarrerEtape('${niveau}', '${difficulte}', ${i})" title="${etape.description}">
                                    <div class="etape-nom">${etape.nom}</div>
                                 </div>`;
                    } else {
                        html += '<div class="matrix-cell etape-empty"></div>';
                    }
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Funktion zum Starten einer √âtape
        function demarrerEtape(niveau, difficulte, etapeIndex) {
            niveauActuel = niveau;
            difficulteActuelle = difficulte;
            etapeActuelle = etapeIndex;
            
            // Lade die √úbungen f√ºr diese √âtape
            demarrerExercicesEtape(niveau, difficulte, etapeIndex);
        }
        
        // Funktion zum Laden der JSON-Dateien (angepasst f√ºr neue Struktur)
        async function chargerExercices(niveau, difficulte) {
            const cacheKey = `${niveau}-${difficulte}`;
            
            // Pr√ºfen ob bereits im Cache
            if (baseExercices[cacheKey]) {
                return baseExercices[cacheKey];
            }
            
            // Einfache relative URL - funktioniert mit lokalem Server und GitHub Pages
            const url = `./mathe/${niveau}-${difficulte}.json`;
            
            try {
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Validierung der neuen Datenstruktur (mit √©tapes)
                if (!data.etapes || !Array.isArray(data.etapes) || data.etapes.length === 0) {
                    throw new Error('Aucune √©tape trouv√©e dans le fichier');
                }
                
                // Validierung der ersten √âtape
                const firstEtape = data.etapes[0];
                if (!firstEtape.exercices || !Array.isArray(firstEtape.exercices)) {
                    throw new Error('Structure d\'√©tape invalide');
                }
                
                // Im Cache speichern
                baseExercices[cacheKey] = data;
                return data;
                
            } catch (error) {
                console.error(`Erreur lors du chargement de ${url}:`, error);
                throw error;
            }
        }

        // Neue Funktion zum Starten einer spezifischen √âtape
        async function demarrerExercicesEtape(niveau, difficulte, etapeIndex) {
            niveauActuel = niveau;
            difficulteActuelle = difficulte;
            etapeActuelle = etapeIndex;
            
            // Statistiken zur√ºcksetzen f√ºr neue √âtape
            bonnesReponses = 0;
            totalReponses = 0;
            exercicesCorrigees.clear();
            tentativesParExercice.clear();
            
            // Wechsle zur Diaporama-Seite
            document.getElementById('selectionPage').style.display = 'none';
            document.getElementById('diaporamaPage').style.display = 'flex';
            
            // Afficher un message de chargement
            document.getElementById('questionExercice').textContent = 'Chargement des exercices...';
            
            try {
                const data = await chargerExercices(niveau, difficulte);
                
                if (!data || !data.etapes || etapeIndex >= data.etapes.length) {
                    alert('Erreur: √âtape non trouv√©e. Veuillez r√©essayer.');
                    document.getElementById('diaporamaPage').style.display = 'none';
                    document.getElementById('selectionPage').style.display = 'flex';
                    return;
                }
                
                const etape = data.etapes[etapeIndex];
                exercicesActuels = [...etape.exercices];
                indexExercice = 0;
                
                // Statistiken zur√ºcksetzen
                bonnesReponses = 0;
                totalReponses = 0;
                
                // M√©langer les exercices
                for (let i = exercicesActuels.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [exercicesActuels[i], exercicesActuels[j]] = [exercicesActuels[j], exercicesActuels[i]];
                }
                
                // Anzeige des Niveau-Infos mit √âtape
                document.getElementById('infoNiveau').textContent = 
                    `${niveau.toUpperCase()} - ${difficulte.charAt(0).toUpperCase() + difficulte.slice(1)} - ${etape.nom}`;
                
                // Audio initialisieren und aktivieren
                initAudio();
                forceAudioInit();
                afficherExercice();
                
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
                alert('Erreur lors du chargement des exercices. Veuillez r√©essayer.');
                document.getElementById('diaporamaPage').style.display = 'none';
                document.getElementById('selectionPage').style.display = 'flex';
            }
        }

        // Variables globales (bereits oben deklariert, hier entfernt)

        // Robuste Audio-Initialisierung
        let audioInitialized = false;
        
        function initAudio() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('AudioContext erstellt, State:', audioContext.state);
                }
                
                // Immer versuchen zu aktivieren
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log('AudioContext aktiviert, State:', audioContext.state);
                        audioInitialized = true;
                    }).catch(e => {
                        console.error('AudioContext Resume Fehler:', e);
                    });
                } else if (audioContext.state === 'running') {
                    audioInitialized = true;
                    console.log('AudioContext bereits aktiv');
                }
            } catch (e) {
                console.error('Audio Initialisierung Fehler:', e);
                audioContext = null;
                audioInitialized = false;
            }
        }
        
        // Erzwinge Audio-Aktivierung bei Benutzerinteraktion
        function forceAudioInit() {
            try {
                if (!audioContext || audioContext.state !== 'running') {
                    initAudio();
                    
                    // Zus√§tzlicher Versuch nach kurzer Verz√∂gerung
                    setTimeout(() => {
                        try {
                            if (audioContext && audioContext.state === 'suspended') {
                                audioContext.resume().then(() => {
                                    console.log('Audio force-aktiviert');
                                    audioInitialized = true;
                                }).catch(e => {
                                    console.error('Resume Fehler:', e);
                                    audioContext = null;
                                    audioInitialized = false;
                                });
                            }
                        } catch (e) {
                            console.error('Force init timeout Fehler:', e);
                            audioContext = null;
                            audioInitialized = false;
                        }
                    }, 100);
                }
            } catch (e) {
                console.error('Force init Fehler:', e);
                audioContext = null;
                audioInitialized = false;
            }
        }

        // Sons simples avec Web Audio API (robuster)
        async function jouerSon(frequence, duree, type = 'sine') {
            try {
                if (!audioContext) {
                    initAudio(); // Versuche Audio zu initialisieren
                }
                
                // AudioContext reaktivieren falls suspended
                if (audioContext && audioContext.state === 'suspended') {
                    await audioContext.resume();
                    console.log('AudioContext reaktiviert');
                }
                
                if (!audioContext || audioContext.state !== 'running') {
                    console.log('AudioContext nicht verf√ºgbar f√ºr Frequenz:', frequence, 'State:', audioContext?.state);
                    return;
                }
                
                const oscillateur = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillateur.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillateur.frequency.setValueAtTime(frequence, audioContext.currentTime);
                oscillateur.type = type;
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duree);
                
                oscillateur.start(audioContext.currentTime);
                oscillateur.stop(audioContext.currentTime + duree);
                
                console.log('Son jou√©:', frequence, 'Hz', 'State:', audioContext.state);
            } catch (e) {
                console.error('Erreur son:', e);
                // Versuche AudioContext neu zu initialisieren
                audioContext = null;
                initAudio();
            }
        }

        // Neue robuste Sound-Funktionen
        function playSound(frequency, duration = 0.2, volume = 0.1) {
            try {
                // Erzwinge Audio-Initialisierung
                forceAudioInit();
                
                // Warte kurz und versuche dann Sound zu spielen
                setTimeout(() => {
                    try {
                        if (audioContext && audioContext.state === 'running') {
                            const oscillator = audioContext.createOscillator();
                            const gainNode = audioContext.createGain();
                            
                            // Fehlerbehandlung f√ºr Oscillator
                            oscillator.onended = function() {
                                // Cleanup - nichts zu tun
                            };
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(audioContext.destination);
                            
                            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                            oscillator.type = 'sine';
                            
                            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
                            // Sicherere exponentialRamp
                            gainNode.gain.exponentialRampToValueAtTime(Math.max(0.001, volume * 0.01), audioContext.currentTime + duration);
                            
                            oscillator.start(audioContext.currentTime);
                            oscillator.stop(audioContext.currentTime + duration);
                            
                            console.log(`üîä Sound gespielt: ${frequency}Hz, State: ${audioContext.state}`);
                        } else {
                            console.warn('‚ùå AudioContext nicht bereit:', audioContext?.state);
                        }
                    } catch (innerError) {
                        console.error('üö´ Inner Sound Fehler:', innerError);
                        // AudioContext neu initialisieren bei Fehlern
                        audioContext = null;
                        audioInitialized = false;
                    }
                }, 50);
                
            } catch (error) {
                console.error('üö´ Outer Sound Fehler:', error);
                // AudioContext neu initialisieren bei Fehlern
                audioContext = null;
                audioInitialized = false;
            }
        }

        function sonCorrect() {
            try {
                console.log('üéâ Spiele Erfolgs-Sound...');
                playSound(523.25, 0.3, 0.15); // Do
                setTimeout(() => {
                    try {
                        playSound(659.25, 0.3, 0.15); // Mi
                    } catch (e) {
                        console.error('Erfolgs-Sound 2 Fehler:', e);
                    }
                }, 150);
                setTimeout(() => {
                    try {
                        playSound(783.99, 0.4, 0.15); // Sol
                    } catch (e) {
                        console.error('Erfolgs-Sound 3 Fehler:', e);
                    }
                }, 300);
            } catch (e) {
                console.error('Erfolgs-Sound Fehler:', e);
            }
        }

        function sonIncorrect() {
            try {
                console.log('‚ùå Spiele Fehler-Sound...');
                playSound(220, 0.4, 0.15);
                setTimeout(() => {
                    try {
                        playSound(196, 0.3, 0.1);
                    } catch (e) {
                        console.error('Fehler-Sound 2 Fehler:', e);
                    }
                }, 200);
            } catch (e) {
                console.error('Fehler-Sound Fehler:', e);
            }
        }
        
        // Alias f√ºr Erfolgsmeldung
        function jouerSonReussite() {
            sonCorrect();
        }

        // Animation de particules
        function creerParticules(element, couleur = '#4caf50') {
            const rect = element.getBoundingClientRect();
            const centreX = rect.left + rect.width / 2;
            const centreY = rect.top + rect.height / 2;

            for (let i = 0; i < 12; i++) {
                const particule = document.createElement('div');
                particule.className = 'particule';
                particule.style.background = couleur;
                particule.style.left = centreX + 'px';
                particule.style.top = centreY + 'px';
                
                const angle = (i / 12) * 2 * Math.PI;
                const distance = 100 + Math.random() * 50;
                const dx = Math.cos(angle) * distance;
                const dy = Math.sin(angle) * distance;
                
                particule.style.setProperty('--dx', dx + 'px');
                particule.style.setProperty('--dy', dy + 'px');
                
                document.body.appendChild(particule);
                
                setTimeout(() => {
                    document.body.removeChild(particule);
                }, 1000);
            }
        }

        // Fallback-Funktion f√ºr alte Links (startet erste √âtape)
        async function demarrerExercices(niveau, difficulte) {
            // Startet automatisch die erste √âtape
            demarrerEtape(niveau, difficulte, 0);
        }

        // Affichage d'un exercice
        function afficherExercice() {
            if (indexExercice >= exercicesActuels.length) {
                indexExercice = 0; // Recommencer
            }
            
            // Sicherstellen, dass alle UI-Elemente sichtbar sind
            document.getElementById('inputReponse').style.display = 'block';
            document.querySelector('.btns-reponse').style.display = 'flex';
            document.getElementById('feedback').style.display = 'block';
            document.querySelector('.navigation-buttons').style.display = 'flex';
            
            const exercice = exercicesActuels[indexExercice];
            document.getElementById('questionExercice').textContent = exercice.question + ' = ?';
            document.getElementById('inputReponse').value = '';
            document.getElementById('inputReponse').disabled = false;
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';
            document.getElementById('btnValider').style.display = 'inline-block';
            document.getElementById('btnCorriger').style.display = 'none';
            document.getElementById('btnContinuer').style.display = 'none';
            // Progress Text aktualisieren
            document.getElementById('progressText').textContent = 
                `Exercice ${indexExercice + 1} / ${exercicesActuels.length}`;
            
            // Progress Bar aktualisieren
            const progressPercentage = ((indexExercice + 1) / exercicesActuels.length) * 100;
            document.getElementById('progressFill').style.width = `${progressPercentage}%`;
            
            reponseValidee = false;
            
            // Focus sur l'input
            setTimeout(() => {
                document.getElementById('inputReponse').focus();
            }, 100);
        }

        // AudioContext bei Benutzerinteraktion aktivieren
        function activerAudio() {
            console.log('üîÑ Aktiviere Audio...');
            forceAudioInit();
        }
        
        // Umfassendes Audio-System Test
        function testAudioSystem() {
            console.log('üß™ === AUDIO SYSTEM TEST ===');
            console.log('AudioContext Status:', audioContext?.state);
            console.log('Audio Initialized:', audioInitialized);
            
            // Erzwinge Initialisierung
            forceAudioInit();
            
            // Test nach kurzer Verz√∂gerung
            setTimeout(() => {
                console.log('Nach Force Init - AudioContext Status:', audioContext?.state);
                
                if (audioContext && audioContext.state === 'running') {
                    console.log('‚úÖ AudioContext l√§uft - teste Sounds...');
                    
                    // Test Erfolgs-Sound
                    setTimeout(() => {
                        console.log('üéâ Teste Erfolgs-Sound...');
                        sonCorrect();
                    }, 500);
                    
                    // Test Fehler-Sound
                    setTimeout(() => {
                        console.log('‚ùå Teste Fehler-Sound...');
                        sonIncorrect();
                    }, 2000);
                    
                } else {
                    console.error('‚ùå AudioContext nicht aktiv:', audioContext?.state);
                    alert('Audio funktioniert nicht. Bitte Browser-Konsole (F12) pr√ºfen.');
                }
            }, 200);
        }
        
        // Einfacher Sound-Test
        function testSound() {
            testAudioSystem();
        }

        // Validation de la r√©ponse
        function validerReponse() {
            // AudioContext bei erster Benutzerinteraktion aktivieren
            activerAudio();
            const input = document.getElementById('inputReponse');
            const reponseUtilisateur = parseFloat(input.value);
            const exercice = exercicesActuels[indexExercice];
            
            if (isNaN(reponseUtilisateur)) {
                alert('Veuillez entrer un nombre !');
                return;
            }
            
            const feedback = document.getElementById('feedback');
            const tolerance = exercice.type === 'decimal' ? 0.01 : 0;
            const estCorrect = Math.abs(reponseUtilisateur - exercice.reponse) <= tolerance;
            
            // Exercice-ID f√ºr Tracking
            const exerciceId = `${indexExercice}_${exercice.question}`;
            
            // Tentatives z√§hlen
            const tentatives = tentativesParExercice.get(exerciceId) || 0;
            tentativesParExercice.set(exerciceId, tentatives + 1);
            
            // Statistiken aktualisieren
            totalReponses++;
            if (estCorrect) {
                // Punkte basierend auf Korrekturen
                const estCorrigee = exercicesCorrigees.has(exerciceId);
                if (estCorrigee) {
                    bonnesReponses += 0.5; // Halbe Punkte f√ºr korrigierte Antworten
                } else {
                    bonnesReponses += 1; // Volle Punkte f√ºr erste richtige Antwort
                }
                
                const message = estCorrigee ? 
                    'üéâ Bravo ! C\'est correct ! (corrig√©)' : 
                    'üéâ Bravo ! C\'est correct !';
                feedback.textContent = message;
                feedback.className = 'feedback correct';
                sonCorrect();
                creerParticules(document.getElementById('exercice-actuel'), '#4caf50');
                
                // Bei richtiger Antwort: direkt weiter
                input.disabled = true;
                document.getElementById('btnValider').style.display = 'none';
                document.getElementById('btnCorriger').style.display = 'none';
                
                // Solution-Button verstecken falls vorhanden
                const btnSolution = document.getElementById('btnVoirSolution');
                if (btnSolution) {
                    btnSolution.style.display = 'none';
                }
                
                if (indexExercice < exercicesActuels.length - 1) {
                    document.getElementById('btnContinuer').style.display = 'inline-block';
                } else {
                    document.getElementById('btnContinuer').style.display = 'none';
                    setTimeout(() => {
                        afficherBewertungsButton();
                    }, 1000);
                }
            } else {
                // Falsche Antwort - NUR Corriger-Button, KEINE L√∂sung
                feedback.textContent = '‚ùå Pas tout √† fait... Essaie encore !';
                feedback.className = 'feedback incorrect';
                sonIncorrect();
                
                input.disabled = true;
                document.getElementById('btnValider').style.display = 'none';
                document.getElementById('btnCorriger').style.display = 'inline-block';
                document.getElementById('btnContinuer').style.display = 'none';
                
                // "Voir la solution" Button hinzuf√ºgen
                let btnSolution = document.getElementById('btnVoirSolution');
                if (!btnSolution) {
                    btnSolution = createSolutionButton();
                }
                btnSolution.style.display = 'inline-block';
            }
            
            reponseValidee = true;
        }

        // Fonction de correction
        function corrigerReponse() {
            const exercice = exercicesActuels[indexExercice];
            const exerciceId = `${indexExercice}_${exercice.question}`;
            
            // Markieren als korrigiert
            exercicesCorrigees.add(exerciceId);
            
            document.getElementById('inputReponse').disabled = false;
            document.getElementById('inputReponse').focus();
            document.getElementById('inputReponse').select();
            document.getElementById('feedback').textContent = 'Essaie encore ! (correction en cours)';
            document.getElementById('feedback').className = 'feedback warning';
            document.getElementById('btnValider').style.display = 'inline-block';
            document.getElementById('btnCorriger').style.display = 'none';
            document.getElementById('btnContinuer').style.display = 'none';
            
            // Solution-Button verstecken
            const btnSolution = document.getElementById('btnVoirSolution');
            if (btnSolution) {
                btnSolution.style.display = 'none';
            }
            
            reponseValidee = false;
        }
        
        // Neue Funktion: Solution-Button erstellen
        function createSolutionButton() {
            const btn = document.createElement('button');
            btn.id = 'btnVoirSolution';
            btn.className = 'btn-voir-solution';
            btn.textContent = 'üëÅÔ∏è Voir la solution';
            btn.onclick = voirSolution;
            
            // Button nach btnCorriger einf√ºgen
            const btnCorriger = document.getElementById('btnCorriger');
            btnCorriger.parentNode.insertBefore(btn, btnCorriger.nextSibling);
            
            return btn;
        }
        
        // Neue Funktion: L√∂sung anzeigen
        function voirSolution() {
            const exercice = exercicesActuels[indexExercice];
            const feedback = document.getElementById('feedback');
            
            feedback.textContent = `üí° La solution est : ${exercice.reponse}`;
            feedback.className = 'feedback solution';
            
            // Alle Buttons au√üer "Continuer" verstecken
            document.getElementById('btnValider').style.display = 'none';
            document.getElementById('btnCorriger').style.display = 'none';
            document.getElementById('btnVoirSolution').style.display = 'none';
            
            // Continuer-Button anzeigen
            if (indexExercice < exercicesActuels.length - 1) {
                document.getElementById('btnContinuer').style.display = 'inline-block';
            } else {
                setTimeout(() => {
                    afficherBewertungsButton();
                }, 1000);
            }
        }
        
        // Neue Funktion zum Fortfahren
        function continuerExercice() {
            if (indexExercice < exercicesActuels.length - 1) {
                indexExercice++;
                afficherExercice();
            } else {
                // Ende erreicht - Button f√ºr Bewertung anzeigen
                afficherBewertungsButton();
            }
        }

        // Navigation (nur noch Pr√©c√©dent, da Continuer den Suivant ersetzt)

        function exercicePrecedent() {
            if (indexExercice > 0) {
                indexExercice--;
                afficherExercice();
            }
            // Am Anfang bleibt man beim ersten Exercice
        }
        
        // Button f√ºr Bewertung anzeigen
        function afficherBewertungsButton() {
            const feedback = document.getElementById('feedback');
            
            // Pr√ºfen ob Button bereits existiert
            if (feedback.querySelector('.bewertungs-button')) {
                return; // Button bereits vorhanden
            }
            
            // Bewertungs-Button hinzuf√ºgen
            const bewertungsButton = document.createElement('div');
            bewertungsButton.className = 'bewertungs-button';
            bewertungsButton.style.marginTop = '20px';
            bewertungsButton.innerHTML = `
                <button onclick="afficherBewertung()" style="
                    padding: 15px 30px; 
                    font-size: 1.2rem; 
                    background: linear-gradient(135deg, #4caf50, #66bb6a); 
                    color: white; 
                    border: none; 
                    border-radius: 12px; 
                    cursor: pointer; 
                    box-shadow: 0 4px 15px rgba(76,175,80,0.3);
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    üèÜ Voir mon r√©sultat
                </button>
            `;
            
            feedback.appendChild(bewertungsButton);
        }
        
        // Bewertung basierend auf Leistung
        function afficherBewertung() {
            const etapeName = matrixData[niveauActuel][difficulteActuelle][etapeActuelle].nom;
            
            // Neues Punktesystem: bonnesReponses kann Dezimalwerte haben
            const nombreExercices = exercicesActuels.length; // Anzahl √úbungen (immer 10)
            const maxPoints = nombreExercices; // Maximale Punkte = Anzahl √úbungen
            const pourcentage = Math.round((bonnesReponses / maxPoints) * 100);
            
            // Zus√§tzliche Statistiken
            const nombreCorrections = exercicesCorrigees.size;
            const premieresReussites = totalReponses - nombreCorrections;
            
            let emoji, couleur, message, motivation;
            
            if (pourcentage >= 90) {
                emoji = "üèÜ";
                couleur = "#FFD700";
                message = "Excellent !";
                motivation = "Tu es un champion des math√©matiques ! Continue comme √ßa !";
            } else if (pourcentage >= 80) {
                emoji = "üåü";
                couleur = "#4caf50";
                message = "Tr√®s bien !";
                motivation = "Superbe travail ! Tu ma√Ætrises bien cette √©tape !";
            } else if (pourcentage >= 70) {
                emoji = "üëç";
                couleur = "#2196f3";
                message = "Bien jou√© !";
                motivation = "C'est un bon r√©sultat ! Avec un peu d'entra√Ænement, tu seras parfait !";
            } else if (pourcentage >= 60) {
                emoji = "üí™";
                couleur = "#ff9800";
                message = "Pas mal !";
                motivation = "Tu progresses bien ! Continue √† t'entra√Æner, tu vas y arriver !";
            } else {
                emoji = "üéØ";
                couleur = "#f44336";
                message = "Continue tes efforts !";
                motivation = "Ne te d√©courage pas ! Chaque erreur est une occasion d'apprendre !";
            }
            
            // Berechne die Anzahl der √úbungen (nicht Versuche)
            // nombreExercices bereits oben definiert
            
            document.getElementById('questionExercice').innerHTML = `
                <div style="text-align: center; color: ${couleur}; font-size: 1.5rem;">
                    ${emoji} ${message} ${emoji}<br>
                    <div style="font-size: 2rem; margin: 15px 0; color: ${couleur};">
                        ${bonnesReponses.toFixed(1)}/${nombreExercices} exercices (${pourcentage}%)
                    </div>
                    <div style="font-size: 1.1rem; color: #333; margin: 15px 0; line-height: 1.4;">
                        ${motivation}
                    </div>
                    <div style="font-size: 0.9rem; color: #666; margin: 15px 0; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                        üìä <strong>D√©tails :</strong><br>
                        üìù Exercices total : ${nombreExercices}<br>
                        üéØ Tentatives total : ${totalReponses}<br>
                        ‚úÖ R√©ussites du premier coup : ${premieresReussites}<br>
                        üîÑ R√©ussites apr√®s correction : ${nombreCorrections}<br>
                        ${nombreCorrections > 0 ? 'üí° Les corrections donnent 0.5 points chacune' : 'üèÜ Aucune correction n√©cessaire !'}
                    </div>
                    <div style="font-size: 1rem; color: #666; margin: 10px 0;">
                        √âtape termin√©e : <strong>"${etapeName}"</strong>
                    </div>
                    <div style="margin-top: 25px;">
                        <button onclick="retourSelection()" style="padding: 15px 30px; font-size: 1.1rem; background: ${couleur}; color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                            ‚ú® Choisir une nouvelle √©tape
                        </button>
                    </div>
                </div>
            `;
            
            // Eingabefeld und Buttons verstecken
            document.getElementById('inputReponse').style.display = 'none';
            document.querySelector('.btns-reponse').style.display = 'none';
            document.getElementById('feedback').style.display = 'none';
            document.querySelector('.navigation-buttons').style.display = 'none';
            
            // Sound je nach Leistung
            if (pourcentage >= 80) {
                jouerSonReussite();
                // Partikel-Animation bei guter Leistung
                creerParticules(document.getElementById('exercice-actuel'), couleur);
            } else {
                // Motivierender Sound auch bei schw√§cherer Leistung
                setTimeout(() => jouerSon(440, 0.3), 100);
                setTimeout(() => jouerSon(523.25, 0.4), 400);
            }
        }
        
        // Alte Erfolgsmeldung (wird nicht mehr verwendet)
        function afficherErfolgsmeldung() {
            // Diese Funktion wird durch afficherBewertung ersetzt
            afficherBewertung();
        }

        function retourSelection() {
            document.getElementById('diaporamaPage').style.display = 'none';
            document.getElementById('selectionPage').style.display = 'flex';
        }

        // Gestion du clavier
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('diaporamaPage').style.display === 'flex') {
                // AudioContext bei Tastatureingabe aktivieren
                activerAudio();
                
                if (event.key === 'Enter') {
                    event.preventDefault();
                    if (!reponseValidee) {
                        validerReponse();
                    } else {
                        continuerExercice();
                    }
                } else if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    exercicePrecedent();
                } else if (event.key === 'Escape') {
                    event.preventDefault();
                    retourSelection();
                }
            }
        });

        // Globaler Error-Handler f√ºr Audio-Probleme
        window.addEventListener('error', function(event) {
            console.error('üö´ Globaler Fehler:', event.error);
            if (event.error && event.error.message && event.error.message.includes('AudioContext')) {
                console.log('üîÑ AudioContext Fehler erkannt - Neuinitialisierung...');
                audioContext = null;
                audioInitialized = false;
            }
        });

        // Auto-focus sur l'input au chargement
        window.addEventListener('load', function() {
            // Animation d'entr√©e pour le titre
            setTimeout(() => {
                document.querySelector('.titre-principal').style.opacity = '1';
            }, 300);
            
            // Standardm√§√üig CE1 Matrix anzeigen
            selectionnerNiveau('ce1');
        });
    </script>
</body>
</html>